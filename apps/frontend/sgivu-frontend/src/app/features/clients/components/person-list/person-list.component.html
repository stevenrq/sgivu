<div class="row g-4 mb-4">
  <div class="col-md-4">
    <app-kpi-card
      label="Personas registradas"
      [value]="listManager.total()"
      icon="bi-people-fill"
      variant="primary"
    ></app-kpi-card>
  </div>
  <div class="col-md-4">
    <app-kpi-card
      label="Personas activas"
      [value]="listManager.active()"
      icon="bi-person-check-fill"
      variant="success"
    ></app-kpi-card>
  </div>
  <div class="col-md-4">
    <app-kpi-card
      label="Personas inactivas"
      [value]="listManager.inactive()"
      icon="bi-person-dash-fill"
      variant="warning"
    ></app-kpi-card>
  </div>
</div>

<div class="card">
  <div class="card-header bg-white py-3">
    <div class="d-flex flex-wrap align-items-start justify-content-between">
      <div>
        <h5 class="card-title mb-1">Personas registradas</h5>
        <p class="text-muted small mb-0">
          Administra clientes personas naturales, su información de contacto y
          estado.
        </p>
      </div>
    </div>

    <div class="filters-panel mt-3">
      <div class="row g-2 g-md-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label filter-label" for="personFilterName"
            >Nombre o apellido</label
          >
          <input
            type="search"
            class="form-control form-control-sm"
            id="personFilterName"
            [(ngModel)]="filters.name"
            (keyup.enter)="applyFilters()"
            placeholder="Buscar personas naturales..."
          />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label filter-label" for="personFilterNationalId"
            >Documento</label
          >
          <input
            type="text"
            class="form-control form-control-sm"
            id="personFilterNationalId"
            [(ngModel)]="filters.nationalId"
            (keyup.enter)="applyFilters()"
            placeholder="Cédula"
          />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label filter-label" for="personFilterEmail"
            >Correo</label
          >
          <input
            type="email"
            class="form-control form-control-sm"
            id="personFilterEmail"
            [(ngModel)]="filters.email"
            (keyup.enter)="applyFilters()"
          />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label filter-label" for="personFilterPhoneNumber"
            >Teléfono</label
          >
          <input
            type="text"
            class="form-control form-control-sm"
            id="personFilterPhoneNumber"
            [(ngModel)]="filters.phoneNumber"
            (keyup.enter)="applyFilters()"
          />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label filter-label" for="personFilterCity"
            >Ciudad</label
          >
          <input
            type="text"
            class="form-control form-control-sm"
            id="personFilterCity"
            [(ngModel)]="filters.city"
            (keyup.enter)="applyFilters()"
          />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label filter-label" for="personFilterEnabled"
            >Estado</label
          >
          <select
            class="form-select form-select-sm"
            id="personFilterEnabled"
            [(ngModel)]="filters.enabled"
          >
            <option value="">Todos</option>
            <option value="true">Activos</option>
            <option value="false">Inactivos</option>
          </select>
        </div>
        <div class="col-12 col-md-auto filter-actions mt-2 mt-md-0">
          <button
            class="btn btn-primary btn-sm"
            type="button"
            (click)="applyFilters()"
          >
            <i class="bi bi-funnel me-1"></i>Aplicar filtros
          </button>
          <button
            class="btn btn-outline-secondary btn-sm"
            type="button"
            (click)="clearFilters()"
          >
            <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (listManager.error()) {
    <div class="alert alert-danger rounded-0 mb-0">
      {{ listManager.error() }}
    </div>
  }

  <div class="card-body p-0">
    <app-data-table
      [loading]="listManager.loading()"
      [minHeight]="320"
      loadingLabel="Cargando personas..."
    >
      <ng-container table-head>
        <tr>
          <th scope="col">Nombre completo</th>
          <th scope="col">Cédula</th>
          <th scope="col">Correo</th>
          <th scope="col">Teléfono</th>
          <th scope="col">Estado</th>
          <th scope="col" class="text-center" *appHasPermission="'person:read'">
            Acciones
          </th>
        </tr>
      </ng-container>
      <ng-container table-body>
        @if (!listManager.loading() && listManager.items().length === 0) {
          <tr>
            <td colspan="6" class="text-center py-5 text-muted">
              No existen personas registradas en este momento.
            </td>
          </tr>
        } @else {
          @for (person of listManager.items(); track person.id) {
            <tr
              appRowNavigate
              [appRowNavigate]="['/clients/persons', person.id, 'detail']"
              [appRowNavigateDisabled]="listManager.loading()"
            >
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar me-3">
                    {{ person.firstName.charAt(0) || "?"
                    }}{{ person.lastName.charAt(0) || "" }}
                  </div>
                  <div>
                    <span class="fw-semibold d-inline-flex flex-column">
                      <span>{{ person.firstName }} {{ person.lastName }}</span>
                    </span>
                    <div class="text-muted small">
                      <i class="bi bi-geo-alt me-1"></i>
                      {{ person.address.city || "Ciudad no definida" }}
                    </div>
                  </div>
                </div>
              </td>
              <td>{{ person.nationalId }}</td>
              <td>{{ person.email }}</td>
              <td>{{ person.phoneNumber }}</td>
              <td>
                @if (person.enabled) {
                  <span
                    class="badge bg-success-subtle text-success-emphasis rounded-pill"
                  >
                    Activo
                  </span>
                } @else {
                  <span
                    class="badge bg-warning-subtle text-warning-emphasis rounded-pill"
                  >
                    Inactivo
                  </span>
                }
              </td>
              <td class="text-center" *appHasPermission="'person:read'">
                <div class="dropdown">
                  <button
                    class="btn btn-outline-secondary btn-sm btn-icon"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a
                        class="dropdown-item"
                        [routerLink]="['/clients/persons', person.id, 'detail']"
                      >
                        <i class="bi bi-eye me-2"></i>Ver detalle
                      </a>
                    </li>
                    <li *appHasPermission="'person:update'">
                      <a
                        class="dropdown-item"
                        [routerLink]="['/clients/persons', person.id]"
                      >
                        <i class="bi bi-pencil-square me-2"></i>Editar
                      </a>
                    </li>
                    <li *appHasPermission="'person:update'">
                      <button
                        class="dropdown-item d-flex align-items-center"
                        type="button"
                        (click)="toggleStatus(person)"
                      >
                        <i
                          class="bi me-2"
                          [ngClass]="
                            person.enabled ? 'bi-toggle-on' : 'bi-toggle-off'
                          "
                        ></i>
                        {{ person.enabled ? "Desactivar" : "Activar" }}
                      </button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          }
        }
      </ng-container>
    </app-data-table>
  </div>

  @if (
    listManager.pager() &&
    listManager.pager()!.totalPages &&
    listManager.pager()!.totalPages > 0
  ) {
    <div
      class="card-footer bg-white d-flex justify-content-between align-items-center flex-wrap gap-2"
    >
      <span class="text-muted"
        >Mostrando {{ listManager.pager()!.numberOfElements }} de
        {{ listManager.pager()!.totalElements }} {{ pagerLabel }}</span
      >
      <app-pager
        [pager]="listManager.pager()!"
        [url]="pagerUrl"
        [queryParams]="activePagerQueryParams"
      ></app-pager>
    </div>
  }
</div>
