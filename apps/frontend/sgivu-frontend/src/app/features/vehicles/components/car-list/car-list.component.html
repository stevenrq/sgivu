<div class="row g-4 mb-4">
  <div class="col-md-4">
    <app-kpi-card
      [value]="listManager.total()"
      icon="bi-car-front-fill"
      label="Inventario total"
      variant="primary"
    ></app-kpi-card>
  </div>
  <div class="col-md-4">
    <app-kpi-card
      [value]="listManager.active()"
      icon="bi-check-circle-fill"
      label="Disponibles"
      variant="success"
    ></app-kpi-card>
  </div>
  <div class="col-md-4">
    <app-kpi-card
      [value]="listManager.inactive()"
      icon="bi-exclamation-triangle-fill"
      label="No disponibles"
      variant="warning"
    ></app-kpi-card>
  </div>
</div>

<div class="card">
  <div
    class="card-header bg-white py-3 d-flex flex-wrap align-items-center justify-content-between gap-3"
  >
    <div>
      <h5 class="card-title mb-1">Automóviles registrados</h5>
      <p class="text-muted small mb-0">
        Consulta, filtra y administra el estado de los automóviles registrados
        en el inventario.
      </p>
    </div>

    <div aria-label="Filtros" class="filters-panel mt-3">
      <div class="row g-2 g-md-3 align-items-end">
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carPlate">Placa</label>
          <input
            [(ngModel)]="filters.plate"
            class="form-control form-control-sm"
            id="carPlate"
            placeholder="Ej: ABC123"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carBrand">Marca</label>
          <input
            [(ngModel)]="filters.brand"
            class="form-control form-control-sm"
            id="carBrand"
            placeholder="Toyota"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carLine">Línea</label>
          <input
            [(ngModel)]="filters.line"
            class="form-control form-control-sm"
            id="carLine"
            placeholder="SE"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carModel">Modelo</label>
          <input
            [(ngModel)]="filters.model"
            class="form-control form-control-sm"
            id="carModel"
            placeholder="Corolla"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carFuel"
            >Combustible</label
          >
          <input
            [(ngModel)]="filters.fuelType"
            class="form-control form-control-sm"
            id="carFuel"
            placeholder="Gasolina"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carBody"
            >Carrocería</label
          >
          <input
            [(ngModel)]="filters.bodyType"
            class="form-control form-control-sm"
            id="carBody"
            placeholder="Sedán"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carTransmission"
            >Transmisión</label
          >
          <input
            [(ngModel)]="filters.transmission"
            class="form-control form-control-sm"
            id="carTransmission"
            placeholder="Automática"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carCity">Ciudad</label>
          <input
            [(ngModel)]="filters.cityRegistered"
            class="form-control form-control-sm"
            id="carCity"
            placeholder="Bogotá"
            type="search"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carStatus">Estado</label>
          <select
            [(ngModel)]="filters.status"
            class="form-select form-select-sm"
            id="carStatus"
          >
            <option value="">Todos</option>
            @for (status of vehicleStatuses; track status) {
              <option [ngValue]="status">
                {{ statusLabel(status) }}
              </option>
            }
          </select>
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carYearFrom"
            >Año desde</label
          >
          <input
            (ngModelChange)="filters.minYear = toNumber($event)"
            [ngModel]="filters.minYear"
            class="form-control form-control-sm"
            id="carYearFrom"
            min="1950"
            type="number"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carYearTo"
            >Año hasta</label
          >
          <input
            (ngModelChange)="filters.maxYear = toNumber($event)"
            [ngModel]="filters.maxYear"
            class="form-control form-control-sm"
            id="carYearTo"
            min="1950"
            type="number"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carMinPrice"
            >Precio mínimo</label
          >
          <input
            (ngModelChange)="onPriceInput('minSalePrice', $event)"
            [ngModel]="priceInputs.minSalePrice"
            class="form-control form-control-sm"
            id="carMinPrice"
            placeholder="$"
            inputmode="decimal"
            pattern="^[0-9.,\\s$]*$"
            type="text"
          />
        </div>
        <div class="col-6 col-md-3 col-xl-2">
          <label class="form-label filter-label" for="carMaxPrice"
            >Precio máximo</label
          >
          <input
            (ngModelChange)="onPriceInput('maxSalePrice', $event)"
            [ngModel]="priceInputs.maxSalePrice"
            class="form-control form-control-sm"
            id="carMaxPrice"
            placeholder="$"
            inputmode="decimal"
            pattern="^[0-9.,\\s$]*$"
            type="text"
          />
        </div>
        <div class="col-12 col-md-auto filter-actions mt-2 mt-md-3">
          <button
            (click)="applyFilters()"
            class="btn btn-primary btn-sm px-3"
            type="button"
          >
            <i class="bi bi-funnel me-1"></i>Aplicar filtros
          </button>
          <button
            (click)="clearFilters()"
            class="btn btn-outline-secondary btn-sm px-3"
            type="button"
          >
            <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (listManager.error()) {
    <div class="alert alert-danger rounded-0 mb-0">
      {{ listManager.error() }}
    </div>
  }

  <div class="card-body p-0">
    <app-data-table
      [loading]="listManager.loading()"
      [minHeight]="360"
      loadingLabel="Cargando automóviles..."
    >
      <ng-container table-head>
        <tr>
          <th scope="col">Placa</th>
          <th scope="col">Marca / Línea</th>
          <th scope="col">Modelo</th>
          <th scope="col">Capacidad de pasajeros</th>
          <th scope="col">Transmisión</th>
          <th scope="col">Estado</th>
          <th class="text-end" scope="col">Precio venta</th>
          <th
            *appHasPermission="['car:update', 'car:delete']; logic: 'OR'"
            class="text-center"
            scope="col"
          >
            Acciones
          </th>
        </tr>
      </ng-container>
      <ng-container table-body>
        @if (!listManager.loading() && listManager.items().length === 0) {
          <tr>
            <td class="text-center text-muted py-4" colspan="9">
              No hay automóviles registrados para los filtros actuales.
            </td>
          </tr>
        }
        @for (car of listManager.items(); track car.id) {
          <tr
            appRowNavigate
            [appRowNavigate]="['/vehicles/cars', car.id, 'details']"
            [appRowNavigateDisabled]="listManager.loading()"
          >
            <td class="fw-semibold">{{ car.plate }}</td>
            <td>
              <span class="d-inline-flex flex-column">
                <span class="fw-semibold">{{ car.brand }}</span>
                <small class="text-muted">{{ car.line }}</small>
              </span>
            </td>
            <td>{{ car.model }}</td>
            <td>{{ car.capacity }} pasajeros</td>
            <td>{{ car.transmission }}</td>
            <td>
              <div *appHasPermission="'car:update'" class="mt-2">
                <select
                  (ngModelChange)="changeStatus(car, $event)"
                  [ngModel]="car.status"
                  class="form-select form-select-sm"
                >
                  @for (status of vehicleStatuses; track status) {
                    <option [value]="status">
                      {{ statusLabel(status) }}
                    </option>
                  }
                </select>
              </div>
            </td>
            <td class="text-end">
              {{ car.salePrice | copCurrency }}
            </td>
            <td *appHasPermission="'car:update'" class="text-center">
              <div class="dropdown">
                <button
                  aria-expanded="false"
                  class="btn btn-outline-secondary btn-sm btn-icon"
                  data-bs-toggle="dropdown"
                  type="button"
                >
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a
                      [routerLink]="['/vehicles/cars', car.id, 'details']"
                      class="dropdown-item"
                    >
                      <i class="bi bi-eye me-2"></i>Ver detalle
                    </a>
                  </li>
                  <li>
                    <a
                      [routerLink]="['/vehicles/cars', car.id]"
                      class="dropdown-item"
                    >
                      <i class="bi bi-pencil-square me-2"></i>Editar
                    </a>
                  </li>
                  <li>
                    <button
                      (click)="toggleAvailability(car)"
                      class="dropdown-item d-flex align-items-center"
                      type="button"
                    >
                      <i
                        [ngClass]="
                          car.status === VehicleStatus.INACTIVE
                            ? 'bi-toggle-off'
                            : 'bi-toggle-on'
                        "
                        class="bi me-2"
                      ></i>
                      {{
                        car.status === VehicleStatus.INACTIVE
                          ? "Activar"
                          : "Desactivar"
                      }}
                    </button>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        }
      </ng-container>
    </app-data-table>
  </div>

  @if (listManager.pager()) {
    <div class="card-footer d-flex justify-content-end">
      <app-pager
        [pager]="listManager.pager()!"
        [url]="pagerUrl"
        [queryParams]="activePagerQueryParams"
      ></app-pager>
    </div>
  }
</div>
